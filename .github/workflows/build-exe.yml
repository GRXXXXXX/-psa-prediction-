name: Build Windows EXE

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyinstaller numpy==2.2.6 scikit-learn==1.5.2 joblib==1.4.2 xgboost==2.1.3 lightgbm==4.5.0

      - name: Build EXE
        run: |
          pyinstaller --name PSA_Predictor --onedir --windowed --noconfirm `
            --add-data "model;model" `
            --collect-submodules sklearn `
            --hidden-import sklearn.utils._typedefs `
            --hidden-import sklearn.utils._heap `
            --hidden-import sklearn.utils._sorting `
            --hidden-import sklearn.utils._vector_sentinel `
            --hidden-import sklearn.neighbors._partition_nodes `
            --hidden-import sklearn.tree._utils `
            --hidden-import sklearn.ensemble._gradient_boosting `
            --hidden-import sklearn.linear_model._logistic `
            --hidden-import sklearn.svm._classes `
            --hidden-import sklearn.preprocessing._data `
            --hidden-import sklearn.preprocessing._encoders `
            --hidden-import xgboost `
            --hidden-import lightgbm `
            desktop_app.py

      - name: Create zip
        run: |
          Compress-Archive -Path dist\PSA_Predictor\* -DestinationPath PSA_Predictor_Windows.zip

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          files: PSA_Predictor_Windows.zip
          body: |
            ## PSA Gray Zone Malignancy Prediction Tool

            **Download and use:**
            1. Download `PSA_Predictor_Windows.zip`
            2. Unzip the file
            3. Double-click `PSA_Predictor.exe`
            4. Input biomarker values and click Predict

            No Python installation required.
